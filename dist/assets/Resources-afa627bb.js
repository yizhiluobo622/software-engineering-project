import{d as I,r as d,o as S,c as i,a,w as v,k as y,F as p,b as m,f as u,t as r,v as B,l as A}from"./index-89733f59.js";import{l as D,c as K,u as k,r as M}from"./resources-4bde5add.js";import{l as P}from"./courses-4127035d.js";import{l as G}from"./tags-e3fc3fa4.js";import{d as N}from"./db-8a84ae2f.js";import"./id-0d1586fb.js";const q={class:"col"},z={class:"panel col"},H={class:"row"},J=["value"],Q={class:"row"},X=["value"],Y={class:"grid cols-3"},Z={class:"h3"},ee={class:"muted"},te={class:"row"},oe=["onUpdate:modelValue","onChange"],ae=["value"],ne={class:"row"},se=["onClick"],le={class:"row"},ie=["onUpdate:modelValue","onChange"],ue=["value","onChange"],de={class:"row"},ce=["onKeydown"],re=["onClick"],ve=["onChange"],pe=["value"],me={class:"row"},fe=["onClick"],Ce=I({__name:"Resources",setup(be){const f=d([]),b=d([]),C=d(""),R=d({}),L=d({}),g=d(""),w=d(""),_=d(""),h=d({}),U=d([]);async function c(){const n=await D();f.value=n.filter(e=>{const s=w.value?e.courseId===w.value:!0,l=_.value?e.type===_.value:!0;return s&&l}),f.value.filter(e=>e.type==="pdf"||e.type==="image").map(e=>e.id);const o={},t={};Object.values(L.value).forEach(e=>URL.revokeObjectURL(e));for(const e of f.value){if(e.type!=="pdf"&&e.type!=="image")continue;const s=await N.resBlobs.get(e.id);let l=s==null?void 0:s.blob;!l&&e.meta&&e.meta.blob instanceof Blob&&(l=e.meta.blob),l&&(o[e.id]=l,e.type==="image"&&(t[e.id]=URL.createObjectURL(l)))}R.value=o,L.value=t,h.value=Object.fromEntries(f.value.map(e=>[e.id,e.courseId||""]))}S(async()=>{b.value=await P(),U.value=await G(),await c()});async function V(n){const o=n.target,t=o.files;if(t){for(const e of Array.from(t)){const s=e.type,l=e.name.toLowerCase(),F=s.includes("pdf")||l.endsWith(".pdf")?"pdf":s.startsWith("image/")?"image":s.includes("msword")||l.endsWith(".doc")||l.endsWith(".docx")?"doc":s.includes("presentation")||l.endsWith(".ppt")||l.endsWith(".pptx")?"ppt":s.startsWith("text/")?"text":"file",x={};x.blob=e,await K({courseId:C.value||void 0,type:F,title:e.name.replace(/\.[^.]+$/,""),authors:[],tags:[],blobRef:"resBlobs",meta:x})}await c(),o&&(o.value="")}}async function j(n,o={}){await k(n.id,{title:n.title,authors:n.authors,...o})}async function O(n){await M(n),await c()}async function T(n){const o=g.value.trim();if(!o)return;const t=Array.from(new Set([...n.tags||[],o]));await k(n.id,{tags:t}),g.value="",await c()}async function W(n){const o=h.value[n.id];await k(n.id,{courseId:o||void 0}),await c()}async function $(n,o){const t=U.value.find(s=>s.id===o);if(!t)return;const e=Array.from(new Set([...n.tags||[],t.name]));await k(n.id,{tags:e}),await c()}async function E(n){const o=R.value[n.id];if(!o&&n.meta&&n.meta.blob instanceof Blob){const t=n.meta.blob,e=URL.createObjectURL(t),s=document.createElement("a");s.href=e,s.download=n.title||"download",s.target="_blank",s.click(),setTimeout(()=>URL.revokeObjectURL(e),5e3);return}if(o){const t=URL.createObjectURL(o),e=document.createElement("a");e.href=t,e.download=n.title||"download",e.target="_blank",e.click(),setTimeout(()=>URL.revokeObjectURL(t),5e3)}}return(n,o)=>(u(),i("div",q,[o[9]||(o[9]=a("div",{class:"row"},[a("div",{class:"h1"},"资源库"),a("span",{class:"muted"},"导入本地文件，预览 PDF，编辑元数据")],-1)),a("div",z,[a("input",{type:"file",multiple:"",onChange:V},null,32),a("div",H,[v(a("select",{"onUpdate:modelValue":o[0]||(o[0]=t=>C.value=t)},[o[4]||(o[4]=a("option",{value:""},"不关联课程",-1)),(u(!0),i(p,null,m(b.value,t=>(u(),i("option",{key:t.id,value:t.id},r(t.name),9,J))),128))],512),[[y,C.value]]),a("button",{onClick:c},"刷新")]),a("div",Q,[v(a("select",{"onUpdate:modelValue":o[1]||(o[1]=t=>w.value=t)},[o[5]||(o[5]=a("option",{value:""},"全部课程",-1)),(u(!0),i(p,null,m(b.value,t=>(u(),i("option",{key:t.id,value:t.id},r(t.name),9,X))),128))],512),[[y,w.value]]),v(a("select",{"onUpdate:modelValue":o[2]||(o[2]=t=>_.value=t)},[...o[6]||(o[6]=[a("option",{value:""},"全部类型",-1),a("option",{value:"pdf"},"PDF",-1),a("option",{value:"image"},"图片",-1),a("option",{value:"text"},"文本",-1)])],512),[[y,_.value]]),a("button",{onClick:c},"筛选")])]),a("div",Y,[(u(!0),i(p,null,m(f.value,t=>(u(),i("div",{key:t.id,class:"panel col"},[a("div",Z,r(t.title),1),a("div",ee,r(t.type)+" · "+r(t.authors.join(", ")),1),a("div",te,[v(a("select",{"onUpdate:modelValue":e=>h.value[t.id]=e,onChange:e=>W(t)},[o[7]||(o[7]=a("option",{value:""},"不关联课程",-1)),(u(!0),i(p,null,m(b.value,e=>(u(),i("option",{key:e.id,value:e.id},r(e.name),9,ae))),128))],40,oe),[[y,h.value[t.id]]])]),a("div",ne,[a("button",{onClick:e=>E(t)},"打开/下载",8,se)]),a("div",le,[v(a("input",{"onUpdate:modelValue":e=>t.title=e,onChange:e=>j(t)},null,40,ie),[[B,t.title]]),a("input",{value:t.authors.join(", "),onChange:e=>j(t,{authors:String(e.target.value).split(",").map(s=>s.trim()).filter(Boolean)})},null,40,ue)]),a("div",de,[v(a("input",{"onUpdate:modelValue":o[3]||(o[3]=e=>g.value=e),placeholder:"添加标签",onKeydown:A(e=>T(t),["enter"])},null,40,ce),[[B,g.value]]),a("button",{onClick:e=>T(t)},"添加",8,re),a("select",{onChange:e=>$(t,e.target.value)},[o[8]||(o[8]=a("option",{value:""},"选择全局标签",-1)),(u(!0),i(p,null,m(U.value,e=>(u(),i("option",{key:e.id,value:e.id},r(e.name),9,pe))),128))],40,ve),a("div",null,[(u(!0),i(p,null,m(t.tags,e=>(u(),i("span",{class:"tag",key:e},r(e),1))),128))])]),a("div",me,[a("button",{class:"danger",onClick:e=>O(t.id)},"删除",8,fe)])]))),128))])]))}});export{Ce as default};
